{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Provisions sub-stacks to compose an environment based on vpc, resources, and applications..",
  "Parameters": {
    "VPCTemplateKey": {
      "Description": "The key of the template for the VPC scaffold substack",
      "Type": "String",
      "Default": "https://s3.amazonaws.com/cfn-templates-dev/vpc/vpc.json"
    },
    "VpcName": {
      "Description": "Name of the VPC - Used to dynamically name the VPC, IGW, Routing Tables and Subnets.",
      "Type": "String",
      "MinLength": "3",
      "MaxLength": "25",
      "ConstraintDescription": "Must be in ALL CAPS with only DASHES as the separator. Examples: DEV-ECS1, US1, STAGING-US1.",
      "AllowedPattern": "^([A-Z-\\d]+)",
      "Default": "VPC-NAME-ENV"
    },
    "VpcCidr": {
      "Description": "The whole VPC CIDR Block. Example: 10.0.0.0/16",
      "Type": "String",
      "ConstraintDescription": "Supports subnet sizes of /16 to /22 only. Input must be a correct CIDR, such as: 10.0.5.0/16",
      "AllowedPattern": "^((\\d)+.){3}(0)\\/(16|17|18|19|20|21|22)",
      "Default": "10.0.0.0/16"
    },
    "SubnetTemplate": {
      "Type": "String",
      "Description": "CF Template URL for creating Public/Private Subnets and NAT ASGs",
      "Default": "https://s3.amazonaws.com/cfn-templates-dev/vpc/vpc_subnet.json"
    },
    "VpcPublicSubnetA": {
      "Description": "Public Subnet (A) CIDR. Leave empty to ignore AZ.",
      "Type": "String",
      "AllowedPattern": "^(((\\d)+.){3}(0)\\/(18|19|20|21|22|23|24|25)|)",
      "Default": "10.0.100.0/24"
    },
    "VpcPublicSubnetB": {
      "Description": "Public Subnet (B) CIDR. Leave empty to ignore AZ.",
      "Type": "String",
      "AllowedPattern": "^(((\\d)+.){3}(0)\\/(18|19|20|21|22|23|24|25)|)"
    },
    "VpcPublicSubnetC": {
      "Description": "Public Subnet (C) CIDR. Leave empty to ignore AZ.",
      "Type": "String",
      "AllowedPattern": "^(((\\d)+.){3}(0)\\/(18|19|20|21|22|23|24|25)|)",
      "Default": "10.0.101.0/24"
    },
    "VpcPublicSubnetD": {
      "Description": "Public Subnet (D) CIDR. Leave empty to ignore AZ.",
      "Type": "String",
      "AllowedPattern": "^(((\\d)+.){3}(0)\\/(18|19|20|21|22|23|24|25)|)"
    },
    "VpcPublicSubnetE": {
      "Description": "Public Subnet (E) CIDR. Leave empty to ignore AZ.",
      "Type": "String",
      "AllowedPattern": "^(((\\d)+.){3}(0)\\/(18|19|20|21|22|23|24|25)|)"
    },
    "VpcPrivateSubnetA": {
      "Description": "Private Subnet (A) CIDR. Leave empty to ignore AZ.",
      "Type": "String",
      "AllowedPattern": "^(((\\d)+.){3}(0)\\/(18|19|20|21|22|23|24|25)|)",
      "Default": "10.0.200.0/24"
    },
    "VpcPrivateSubnetB": {
      "Description": "Private Subnet (B) CIDR. Leave empty to ignore AZ.",
      "Type": "String",
      "AllowedPattern": "^(((\\d)+.){3}(0)\\/(18|19|20|21|22|23|24|25)|)"
    },
    "VpcPrivateSubnetC": {
      "Description": "Private Subnet (C) CIDR. Leave empty to ignore AZ.",
      "Type": "String",
      "AllowedPattern": "^(((\\d)+.){3}(0)\\/(18|19|20|21|22|23|24|25)|)",
      "Default": "10.0.201.0/24"
    },
    "VpcPrivateSubnetD": {
      "Description": "Private Subnet (D) CIDR. Leave empty to ignore AZ.",
      "Type": "String",
      "AllowedPattern": "^(((\\d)+.){3}(0)\\/(18|19|20|21|22|23|24|25)|)"
    },
    "VpcPrivateSubnetE": {
      "Description": "Private Subnet (E) CIDR. Leave empty to ignore AZ.",
      "Type": "String",
      "AllowedPattern": "^(((\\d)+.){3}(0)\\/(18|19|20|21|22|23|24|25)|)"
    },
    "ResourcesTemplateKey": {
      "Description": "The key of the template for the EB resources and application substack",
      "Type": "String",
      "Default": "https://s3.amazonaws.com/cfn-templates-dev/vpc/resources.json"
    },
    "DatabaseUser": {
      "Default": "admin",
      "NoEcho": "true",
      "Type": "String",
      "Description": "Database admin account name",
      "MinLength": "1",
      "MaxLength": "16",
      "AllowedPattern": "[a-zA-Z][a-zA-Z0-9]*",
      "ConstraintDescription": "must begin with a letter and contain only alphanumeric characters."
    },
    "DatabasePassword": {
      "Default": "admin",
      "NoEcho": "true",
      "Type": "String",
      "Description": "Database admin account password",
      "MinLength": "1",
      "MaxLength": "41",
      "AllowedPattern": "[a-zA-Z0-9]*",
      "ConstraintDescription": "must contain only alphanumeric characters."
    },
    "DatabaseName": {
      "Description": "The name of the database",
      "Type": "String",
      "Default": "application_db"
    },
    "AppTemplateKey": {
      "Description": "The key of the template for that contains the EB app and env embedded in ResourcesTemplateKey",
      "Type": "String",
      "Default": "https://s3.amazonaws.com/cfn-templates-dev/vpc/application.json"
    },
    "ApplicationName": {
      "Description": "The name of the Elastic Beanstalk Application",
      "Type": "String",
      "Default": "ApplicationName"
    },
    "InstanceType": {
      "Description": "The type of instance to use for EB app servers",
      "Type": "String",
      "Default": "t1.micro",
      "AllowedValues": [
        "t1.micro",
        "m1.small",
        "m1.medium",
        "m1.large"
      ]
    },
    "WarKey": {
      "Description": "The key of the application WAR file in the WarBucket",
      "Type": "String",
      "Default": "https://s3.amazonaws.com/cfn-templates-dev/app.war"
    },
    "KeyName": {
      "Description": "Name of an existing EC2 KeyPair to enable SSH access to the Elastic Beanstalk and Bastion hosts",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255",
      "AllowedPattern": "[\\x20-\\x7E]*",
      "ConstraintDescription": "can contain only ASCII characters.",
      "Default": "keyname"
    },
    "BastionInstanceType": {
      "Description": "Bastion Host EC2 instance type",
      "Type": "String",
      "Default": "t1.micro",
      "AllowedValues": [
        "t1.micro",
        "m1.small",
        "m1.medium",
        "m1.large",
        "m1.xlarge",
        "m2.xlarge",
        "m2.2xlarge",
        "m2.4xlarge",
        "m3.xlarge",
        "m3.2xlarge",
        "c1.medium",
        "c1.xlarge",
        "cc1.4xlarge",
        "cc2.8xlarge",
        "cg1.4xlarge"
      ],
      "ConstraintDescription": "must be a valid EC2 instance type."
    },
    "SSHFrom": {
      "Description": "Lockdown SSH access to the bastion host (default can be accessed from anywhere)",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "Default": "0.0.0.0/0",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "must be a valid CIDR range of the form x.x.x.x/x."
    }
  },
  "Resources": {
    "VPCScaffold": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": {
          "Ref": "VPCTemplateKey"
        },
        "Parameters": {
          "VpcPublicSubnetA": {
            "Ref": "VpcPublicSubnetA"
          },
          "VpcPublicSubnetB": {
            "Ref": "VpcPublicSubnetB"
          },
          "VpcPublicSubnetC": {
            "Ref": "VpcPublicSubnetC"
          },
          "VpcPublicSubnetD": {
            "Ref": "VpcPublicSubnetD"
          },
          "VpcPublicSubnetE": {
            "Ref": "VpcPublicSubnetE"
          },
          "VpcPrivateSubnetA": {
            "Ref": "VpcPrivateSubnetA"
          },
          "VpcPrivateSubnetB": {
            "Ref": "VpcPrivateSubnetB"
          },
          "VpcPrivateSubnetC": {
            "Ref": "VpcPrivateSubnetC"
          },
          "VpcPrivateSubnetD": {
            "Ref": "VpcPrivateSubnetD"
          },
          "VpcPrivateSubnetE": {
            "Ref": "VpcPrivateSubnetE"
          },
          "VpcName": {
            "Ref": "VpcName"
          },
          "VpcCidr": {
            "Ref": "VpcCidr"
          },
          "SubnetTemplate": {
            "Ref": "SubnetTemplate"
          }
        }
      }
    }
  }
}

